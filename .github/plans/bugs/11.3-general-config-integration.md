# Bug #11.3: 一般配置整合優化

## 關聯問題
- **主議題**: [Bug #11: 配置項目整合問題](11-config-integration-issues.md)
- **前置依賴**: Bug #11.1（AI 配置整合）

## 問題描述

一般配置區塊中有部分配置項目已定義但未在實際命令中充分使用。根據配置使用分析，以下項目需要進一步整合：

### 需要整合的配置
- `enable_progress_bar`: 進度條顯示功能（已定義但未在所有適用命令中使用）
- `task_timeout_seconds`: 任務執行逾時設定（已定義但調度器未使用）
- `worker_idle_timeout_seconds`: 工作執行緒閒置逾時（已定義但調度器未使用）

### 已使用的配置
- `backup_enabled`: 自動備份功能（已在 match 命令中使用）
- `max_concurrent_jobs`: 並行任務調度器的最大並發數（已在 match 命令中使用）

## 技術分析

### 1. 進度條顯示系統
**問題**: `enable_progress_bar` 配置已定義但僅在部分命令中實作進度條顯示
**目前狀況**: 配置存在且可設定，但各命令的進度條實作不一致

**需要整合的命令**:
- `sync` 命令: 需要新增音訊處理進度條
- `match` 命令: 需要新增匹配進度條  
- `convert` 命令: 需要檢查是否正確讀取配置
- `detect-encoding` 命令: 需要新增檔案掃描進度條

### 2. 任務調度器逾時配置
**問題**: `task_timeout_seconds` 和 `worker_idle_timeout_seconds` 已定義但調度器未使用
**影響**: TaskScheduler 無法根據配置控制任務逾時和工作執行緒管理

### 3. 配置整合現狀
**已整合**: 
- `backup_enabled`: 在 MatchCommand 中已正確使用
- `max_concurrent_jobs`: 在 TaskScheduler 中已正確使用

**待整合**:
- `enable_progress_bar`: 需要在各命令中統一實作
- `task_timeout_seconds`: 需要整合到 TaskScheduler
- `worker_idle_timeout_seconds`: 需要整合到 TaskScheduler

## 實作計畫

### 階段 1: 進度條系統標準化
**目標**: 在所有適用命令中統一實作進度條顯示

#### 步驟 1.1: 設計進度條工具模組
```
src/core/progress/
├── mod.rs           # 模組入口
├── bar.rs           # 進度條實作
└── config.rs        # 進度條配置
```

#### 步驟 1.2: 實作進度條工具
- 建立統一的進度條介面
- 支援不同類型的進度顯示（檔案處理、匹配進度等）
- 根據 `enable_progress_bar` 配置控制顯示

#### 步驟 1.3: 整合到各命令
- `sync` 命令: 新增音訊處理進度條
- `match` 命令: 新增匹配進度條
- `detect-encoding` 命令: 新增檔案掃描進度條
- `convert` 命令: 優化現有進度條實作

### 階段 2: 任務調度器逾時配置整合
**目標**: 將 task_timeout_seconds 和 worker_idle_timeout_seconds 整合到任務調度器

#### 步驟 2.1: 修改 TaskScheduler
- 在 TaskScheduler 中新增逾時配置參數
- 實作任務執行逾時機制
- 實作工作執行緒閒置逾時機制

#### 步驟 2.2: 整合配置
- 從 GeneralConfig 讀取逾時配置
- 在任務調度時應用逾時設定
- 新增逾時錯誤處理機制

## 技術實作細節

### 進度條系統設計
```rust
// src/core/progress/bar.rs
pub struct ProgressManager {
    enabled: bool,
    bars: HashMap<String, ProgressBar>,
}

impl ProgressManager {
    pub fn new(config: &Config) -> Self {
        Self {
            enabled: config.general.enable_progress_bar,
            bars: HashMap::new(),
        }
    }
    
    pub fn create_bar(&mut self, id: &str, total: u64, message: &str) -> Option<&ProgressBar> {
        if !self.enabled {
            return None;
        }
        // 建立進度條實作
    }
}
```

### 任務調度器逾時設計
```rust
// src/core/parallel/scheduler.rs
pub struct TaskScheduler {
    task_timeout: Duration,
    worker_idle_timeout: Duration,
    // 其他欄位...
}

impl TaskScheduler {
    pub fn new(config: &GeneralConfig) -> Self {
        Self {
            task_timeout: Duration::from_secs(config.task_timeout_seconds),
            worker_idle_timeout: Duration::from_secs(config.worker_idle_timeout_seconds),
            // 其他初始化...
        }
    }
    
    pub fn execute_with_timeout<T>(&self, task: T) -> Result<T::Output>
    where
        T: Future + Send + 'static,
    {
        // 實作任務逾時執行邏輯
    }
}
```

## 測試策略

### 單元測試
- 進度條管理器功能測試
- 任務調度器逾時功能測試
- 配置載入測試

### 整合測試
- 各命令的進度條顯示測試
- 任務逾時處理測試
- 工作執行緒管理測試

### 測試檔案
```
tests/
├── progress_integration_tests.rs
├── timeout_integration_tests.rs
└── scheduler_integration_tests.rs
```

## 驗收標準

### 功能驗收
- [ ] 所有命令正確讀取 `enable_progress_bar` 配置
- [ ] 進度條在長時間操作中正常顯示
- [ ] 任務調度器正確應用 `task_timeout_seconds` 配置
- [ ] 工作執行緒正確應用 `worker_idle_timeout_seconds` 配置
- [ ] 逾時錯誤處理機制正常運作

### 相容性驗收
- [ ] 向後相容現有配置檔案
- [ ] 預設配置下功能正常
- [ ] 配置驗證正確處理無效值

## 風險評估

### 技術風險
- **中等**: 進度條實作可能影響並行處理效能
- **中等**: 任務逾時機制實作需要仔細設計避免資源洩漏

### 相容性風險
- **低等**: 新功能為可選項目，不影響現有功能

## 預期工作量
- **開發時間**: 4-6 個工作日
- **測試時間**: 2-3 個工作日
- **總計**: 6-9 個工作日

## 後續步驟
1. 實作進度條系統核心模組
2. 整合進度條到 sync 和 match 命令
3. 實作自動備份功能
4. 標準化詳細輸出系統
5. 撰寫完整測試套件
6. 更新使用文件
