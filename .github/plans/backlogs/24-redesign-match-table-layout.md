# 重新設計 Match 命令表格版面配置

## 背景與問題描述

目前的 match 命令輸出表格採用水平多欄位設計，每個匹配結果佔用一行，包含 "Status", "Video File", "Subtitle File", "New Name" 四個欄位水平排列。這種設計存在以下問題：

1. **表格過於寬廣**：四個欄位水平排列使表格在終端中佔用過多水平空間，在窄螢幕或小終端視窗中難以閱讀
2. **檔案路徑截斷問題**：長檔案路徑在有限的欄位寬度中無法完整顯示，影響使用者識別檔案
3. **資訊密度過高**：所有資訊擠在一行中，視覺上難以區分和快速掌握
4. **編號前綴冗餘**：每個檔案名稱前的編號前綴（如 "Video file 1"）增加了不必要的視覺雜訊

## 目標

重新設計表格版面配置，採用垂直資訊組織方式，實現以下目標：

1. **垂直資訊佈局**：每個匹配結果使用多行顯示，將相關檔案資訊垂直排列
2. **簡化欄位結構**：從四欄位水平設計改為兩欄位設計（Status + Filename）
3. **完整路徑顯示**：確保檔案路徑能夠完整顯示，不受欄位寬度限制
4. **清晰的資訊分組**：每個匹配結果內的影片檔案、字幕檔案和新名稱清楚分組顯示
5. **保持功能完整性**：確保所有必要資訊仍能有效傳達，且更易於閱讀

## 詳細需求規格

### 1. 新表格結構設計

#### 欄位定義
- **Status（狀態）**：顯示處理狀態的視覺圖示
- **Filename（檔案名稱）**：整合顯示影片檔案、字幕檔案和新名稱資訊

#### 狀態圖示規範
- `✓` 或 `✅`：成功完成處理
- `🔍`：預覽模式（dry-run）
- `⚠`：警告（例如：信心度較低）
- `✗`：處理失敗

### 2. Filename 欄位內容格式

每個匹配結果將佔用多行來顯示完整的檔案資訊，採用垂直堆疊的方式組織：

```
Video 1:    /完整/路徑/到/影片檔案.mkv
Subtitle 1: /完整/路徑/到/原始字幕檔案.srt
→ New name: /完整/路徑/到/新字幕檔案名稱.srt
```

### 3. 表格行為設計

- **狀態欄位**：每個匹配結果組的第一行顯示狀態圖示，後續行在狀態欄位保持空白或顯示連接符號
- **檔案名稱欄位**：顯示多行檔案資訊，每行包含檔案類型標識和完整路徑
- **視覺分隔**：不同匹配結果之間可考慮添加分隔線提高可讀性

### 4. 狀態顯示策略

對於多行顯示的匹配結果，狀態圖示的顯示方式：

**使用連接符號**
```
✓ Video 1    /path/to/video.mkv
├ Subtitle 1 /path/to/subtitle.srt
└ New name 1 /path/to/video.srt
```

## 實作計劃

### 階段一：資料結構重構

#### 1.1 修改 MatchDisplayRow 結構體

**檔案位置**: `src/cli/table.rs`

**具體任務**:
1. 重新定義 `MatchDisplayRow` 結構體，將四個欄位簡化為兩個欄位
2. 調整 `#[tabled(rename = "...")]` 屬性為正體中文標題
3. 更新相關文件註解

**預期改動**:
```rust
#[derive(Tabled)]
pub struct MatchDisplayRow {
    #[tabled(rename = "狀態")]
    pub status: String,
    
    #[tabled(rename = "檔案名稱")]
    pub filename: String,
}
```

#### 1.2 實作多行檔案資訊格式化邏輯

**任務**:
1. 建立多行格式化函式，將每個匹配結果轉換為多行顯示格式
2. 實作檔案資訊顯示方案
3. 處理檔案路徑的完整顯示和美化
4. 實作狀態欄位的多行對應邏輯（首行顯示、連接符號、垂直對齊等）

**技術重點**:
- 每個 `MatchDisplayRow` 可能需要表示為多個表格行
- 考慮使用 `Vec<MatchDisplayRow>` 來表示單一匹配結果的多行顯示
- 狀態欄位在同一匹配結果組內的一致性處理

### 階段二：顯示邏輯更新

#### 2.1 修改 display_match_results 函式

**檔案位置**: `src/cli/ui.rs`

**具體任務**:
1. 更新 `display_match_results` 函式以支援多行顯示邏輯
2. 實作從單一 `MatchOperation` 到多個 `MatchDisplayRow` 的轉換
3. 移除編號前綴的冗餘，改用更清晰的檔案類型標識
4. 處理多行結果的狀態欄位顯示邏輯

**預期改動重點**:
- 每個匹配結果生成 3 行表格內容（影片、字幕、新名稱）
- 狀態欄位採用適當的多行顯示策略
- 確保檔案路徑完整顯示而不截斷
- 保持不同匹配結果之間的清晰視覺分隔

#### 2.2 優化狀態顯示

**任務**:
1. 統一狀態圖示的使用
2. 確保 dry-run 和實際執行模式的狀態顯示一致性
3. 添加適當的顏色編碼（如果終端支援）

### 階段三：使用者體驗改善

#### 3.1 表格樣式優化

**任務**:
1. 調整表格行高和間距以適應多行內容
2. 優化狀態欄位在多行顯示中的對齊方式
3. 確保表格在不同終端寬度下的適應性
4. 考慮在不同匹配結果之間添加視覺分隔（如分隔線或空行）
5. 處理長檔案路徑在終端中的換行和顯示

### 階段四：測試與驗證

#### 4.1 單元測試更新

**檔案位置**: `src/cli/ui.rs` (測試模組)

**任務**:
1. 更新現有的 `test_match_table_display` 測試以支援多行格式
2. 添加多行顯示格式的測試案例
3. 測試不同狀態顯示策略的正確性
4. 驗證多個匹配結果的表格輸出格式
5. 測試邊界情況（空結果、單一結果、大量結果）

#### 4.2 整合測試

**任務**:
1. 測試 match 命令的端到端多行表格輸出
2. 驗證 dry-run 和實際執行模式的多行表格顯示
3. 測試不同數量匹配結果的表格呈現效果
4. 驗證長檔案路徑的完整顯示
5. 測試特殊字元和 Unicode 檔案名稱的處理

#### 4.3 視覺效果驗證

**任務**:
1. 在不同終端環境中測試多行表格顯示效果
2. 驗證表格在不同寬度終端中的適應性和換行行為
3. 確認多行內容的對齊和視覺一致性
4. 測試狀態欄位在多行顯示中的視覺效果
5. 驗證不同匹配結果之間的視覺分隔效果

## 技術考量

### 1. 向後相容性

- 由於這是 CLI 輸出格式的變更，不涉及 API 破壞性改動
- 需要更新相關文件和範例
- 考慮是否需要設定選項讓使用者選擇表格格式

### 2. 效能影響

- 格式化邏輯的變更對效能影響極小
- 字串處理的最佳化（避免不必要的記憶體分配）

### 3. 測試覆蓋率

- 確保所有表格顯示邏輯都有對應的單元測試
- 特別關注中文字元處理的測試覆蓋

## 驗收標準

### 功能驗收
1. ✅ 表格改為兩欄位設計（狀態 + 檔案名稱），每個匹配結果使用多行顯示
2. ✅ 每個匹配結果包含影片檔案、字幕檔案和新名稱三行資訊
3. ✅ 檔案路徑能夠完整顯示，不受欄位寬度限制截斷
4. ✅ 狀態欄位在多行顯示中保持適當的視覺指示
5. ✅ 移除編號前綴冗餘，使用清晰的檔案類型標識
6. ✅ 保持所有原有功能資訊的完整性

### 品質驗收
1. ✅ 所有現有測試通過
2. ✅ 新增測試覆蓋多行顯示格式
3. ✅ 狀態欄位多行顯示邏輯測試完備
4. ✅ 程式碼格式化通過 (`cargo fmt`)
5. ✅ 靜態分析通過 (`cargo clippy`)

### 使用者體驗驗收
1. ✅ 多行表格在標準終端寬度下顯示良好
2. ✅ 檔案路徑完整顯示，提升可讀性
3. ✅ 狀態指示在多行格式中清晰可見
4. ✅ 不同匹配結果之間有適當的視覺分隔
5. ✅ 長檔案路徑處理合理，不影響表格結構
6. ✅ 多行內容對齊一致，視覺效果佳

## 風險評估

### 低風險
- **表格格式變更**：純展示層面的改動，不影響核心邏輯

### 中風險
- **中文顯示相容性**：需要確保在各種終端環境中正確顯示

### 緩解措施
- 充分的跨平台測試
- 提供回退機制（如果中文顯示有問題，提供英文版本）

## 後續改進機會

1. **表格格式設定選項**：允許使用者選擇表格顯示格式
2. **主題支援**：支援不同的顏色主題
3. **輸出格式選項**：支援 JSON、CSV 等格式輸出
4. **國際化支援**：為其他語言使用者提供多語言支援

## 預估工作量

- **資料結構重構**：6-8 小時
- **多行顯示邏輯實作**：8-12 小時  
- **狀態欄位多行處理**：4-6 小時
- **測試開發與更新**：6-8 小時
- **視覺效果調整與優化**：4-6 小時
- **文件更新**：2-3 小時
- **總計**：30-43 小時

此工作項目屬於中高複雜度的 UI 重構工作，涉及表格顯示邏輯的根本性改變。需要仔細處理多行顯示的各種邊界情況和視覺效果。建議由經驗豐富的 Rust 開發者負責，並安排充足的測試時間確保品質。
