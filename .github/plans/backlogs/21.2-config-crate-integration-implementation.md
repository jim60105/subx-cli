# Backlog #21.2: config crate 整合與基礎實作

## 概述

本子任務負責實作 config crate 的基礎整合，建立新的配置載入機制，並提供向後相容性。這是技術遷移的第一個實作階段。

## 實作計劃

### 階段 1：配置依賴項目和基礎設定 (1 天)

#### 1.1 添加 config crate 依賴
```toml
# Cargo.toml
[dependencies]
config = "0.15"
serde = { version = "1.0", features = ["derive"] }
```

#### 1.2 分析當前配置使用模式
基於程式碼分析，當前系統中的主要配置使用點：

**配置結構體對應**：
- `Config` → 直接對應 `config::Config::try_deserialize::<Config>()`
- `AIConfig` → AI 服務配置（OpenAI API、模型設定等）
- `SyncConfig` → 音訊同步配置（對話檢測、相關性閾值等）
- `FormatsConfig` → 字幕格式配置
- `GeneralConfig` → 一般設定
- `ParallelConfig` → 並行處理配置

**主要使用點**：
1. `init_config_manager()` → 替換為 `config::Config::builder().build()`
2. `load_config()` → 替換為依賴注入的配置服務
3. `reset_global_config_manager()` → 完全移除（測試使用獨立配置實例）

### 階段 2：建立新配置載入機制 (1.5 天)

#### 2.1 建立新配置載入函式
```rust
// src/config.rs 新增
use config::{Config as ConfigBuilder, Environment, File};

/// 使用 config crate 建立配置實例
pub fn create_config_from_sources() -> Result<Config> {
    let config_path = dirs::config_dir()
        .unwrap_or_else(|| PathBuf::from("."))
        .join("config.toml");
    
    let config = ConfigBuilder::builder()
        // 1. 預設配置
        .add_source(config::File::with_name("config/default").required(false))
        // 2. 用戶配置檔案
        .add_source(config::File::from(config_path).required(false))
        // 3. 環境變數
        .add_source(Environment::with_prefix("SUBX").separator("_"))
        .build()
        .map_err(SubXError::from)?;
    
    config.try_deserialize().map_err(SubXError::from)
}

/// 建立帶有動態覆蓋的配置實例
pub fn create_config_with_overrides(overrides: Vec<(String, String)>) -> Result<Config> {
    let config_path = dirs::config_dir()
        .unwrap_or_else(|| PathBuf::from("."))
        .join("config.toml");
    
    let mut builder = ConfigBuilder::builder()
        .add_source(config::File::with_name("config/default").required(false))
        .add_source(config::File::from(config_path).required(false))
        .add_source(Environment::with_prefix("SUBX").separator("_"));
    
    // 動態添加覆蓋 (CLI 參數等)
    for (key, value) in overrides {
        builder = builder.set_override(key, value)?;
    }
    
    let config = builder.build().map_err(SubXError::from)?;
    config.try_deserialize().map_err(SubXError::from)
}
```

#### 2.2 建立測試專用配置建立器
```rust
// src/config.rs 新增測試輔助
#[cfg(test)]
pub fn create_test_config(overrides: Vec<(&str, &str)>) -> Config {
    use config::{Config as ConfigBuilder};
    
    let mut builder = ConfigBuilder::builder()
        .set_default("ai.provider", "openai").unwrap()
        .set_default("ai.model", "gpt-4o-mini").unwrap()
        .set_default("ai.max_sample_length", 3000).unwrap()
        .set_default("sync.correlation_threshold", 0.8).unwrap()
        .set_default("sync.max_offset_seconds", 10.0).unwrap()
        .set_default("formats.srt.enable", true).unwrap()
        .set_default("parallel.max_workers", 4).unwrap();
    
    for (key, value) in overrides {
        builder = builder.set_override(key, value).unwrap();
    }
    
    builder.build().unwrap().try_deserialize().unwrap()
}
```

#### 2.3 保持向後相容性
```rust
// src/config.rs 更新 - 提供過渡期相容性
#[deprecated(note = "Use create_config_from_sources() instead")]
pub fn init_config_manager() -> Result<()> {
    log::warn!("init_config_manager is deprecated, use create_config_from_sources instead");
    Ok(())
}

#[deprecated(note = "Use create_config_from_sources() instead")]  
pub fn load_config() -> Result<Config> {
    log::warn!("load_config is deprecated, use create_config_from_sources instead");
    create_config_from_sources()
}
```

### 階段 3：錯誤處理整合 (0.5 天)

#### 3.1 建立錯誤處理整合
```rust
// src/error.rs 更新
impl From<config::ConfigError> for SubXError {
    fn from(err: config::ConfigError) -> Self {
        SubXError::config(&format!("Configuration error: {}", err))
    }
}
```

#### 3.2 環境變數對應設定
```bash
# 環境變數映射範例
export SUBX_AI_PROVIDER="openai"
export SUBX_AI_API_KEY="sk-..."
export SUBX_AI_MODEL="gpt-4"
export SUBX_SYNC_MAX_OFFSET_SECONDS="20.0"
export SUBX_SYNC_CORRELATION_THRESHOLD="0.8"
```

### 階段 4：基礎驗證測試 (0.5 天)

#### 4.1 驗證基本整合
```bash
cargo build --all-targets
cargo check --all-features
```

#### 4.2 建立基礎功能測試
```rust
// tests/config_basic_integration.rs
#[test]
fn test_create_config_from_sources() {
    let config = create_config_from_sources().unwrap();
    
    // 驗證預設值載入
    assert_eq!(config.ai.provider, "openai");
    assert_eq!(config.ai.model, "gpt-4o-mini");
    assert_eq!(config.ai.max_sample_length, 3000);
}

#[test]
fn test_config_with_overrides() {
    let overrides = vec![
        ("ai.provider".to_string(), "anthropic".to_string()),
        ("ai.model".to_string(), "claude-3".to_string()),
    ];
    
    let config = create_config_with_overrides(overrides).unwrap();
    assert_eq!(config.ai.provider, "anthropic");
    assert_eq!(config.ai.model, "claude-3");
    assert_eq!(config.ai.max_sample_length, 3000); // 保持預設值
}

#[test]
fn test_create_test_config() {
    let config = create_test_config(vec![
        ("ai.provider", "anthropic"),
        ("sync.correlation_threshold", "0.6"),
    ]);
    
    assert_eq!(config.ai.provider, "anthropic");
    assert_eq!(config.sync.correlation_threshold, 0.6);
    assert_eq!(config.ai.model, "gpt-4o-mini"); // 預設值保持
}
```

#### 4.3 配置來源優先級測試
```rust
#[test]
fn test_config_priority_order() {
    // 建立測試檔案
    std::fs::write("test_config.toml", r#"
[ai]
provider = "file_provider"
model = "file_model"
"#).unwrap();
    
    // 設定環境變數
    std::env::set_var("SUBX_AI_PROVIDER", "env_provider");
    
    let config = ConfigBuilder::builder()
        .add_source(config::File::with_name("test_config"))
        .add_source(Environment::with_prefix("SUBX").separator("_"))
        .set_override("ai.model", "override_model")
        .unwrap()
        .build()
        .unwrap()
        .try_deserialize::<Config>()
        .unwrap();
    
    // 驗證優先級：override > env > file
    assert_eq!(config.ai.provider, "env_provider");     // 環境變數覆蓋檔案
    assert_eq!(config.ai.model, "override_model");      // 覆蓋值最高優先級
    
    // 清理
    std::fs::remove_file("test_config.toml").ok();
    std::env::remove_var("SUBX_AI_PROVIDER");
}
```

## 具體使用點遷移計劃

### 主要遷移點分析（基於程式碼搜尋結果）

**1. `src/config.rs` (54 處使用)**
- 移除 `init_config_manager()`, `load_config()`, `reset_global_config_manager()`
- 添加 `create_config_from_sources()` 函式
- 移除 `GLOBAL_CONFIG_MANAGER` 靜態變數

**2. 遷移對應表**

| 當前使用 | 遷移目標 | 影響的檔案 |
|---------|---------|-----------|
| `init_config_manager()` | `create_config_from_sources()` | `src/main.rs` |
| `load_config()` | `create_config_from_sources()` | 所有使用配置的模組 |
| `reset_global_config_manager()` | 移除（測試使用獨立實例） | 所有測試檔案 |
| `GLOBAL_CONFIG_MANAGER` | 移除 | `src/config.rs` |

### CLI 參數整合範例

當前的 CLI 來源功能可以透過 `set_override` 實現：

```rust
// 當前複雜的 CLI 整合
let cli_source = CliSource::new(cli_args);

// config crate 簡化方式
let mut builder = ConfigBuilder::builder()
    .add_source(File::with_name("config"))
    .add_source(Environment::with_prefix("SUBX"));

// 動態添加 CLI 覆蓋
if let Some(provider) = cli_args.ai_provider {
    builder = builder.set_override("ai.provider", provider)?;
}
if let Some(model) = cli_args.ai_model {
    builder = builder.set_override("ai.model", model)?;
}

let config: Config = builder.build()?.try_deserialize()?;
```

## 效能和相容性驗證

### 配置載入效能測試
```rust
// 建立效能測試
#[cfg(test)]
mod performance_tests {
    use super::*;
    use std::time::Instant;

    #[test]
    fn test_config_loading_performance() {
        let start = Instant::now();
        
        for _ in 0..100 {
            let _config = create_config_from_sources().unwrap();
        }
        
        let duration = start.elapsed();
        assert!(duration < std::time::Duration::from_millis(500));
        println!("100 config loads took: {:?}", duration);
    }
    
    #[test]
    fn test_test_config_performance() {
        let start = Instant::now();
        
        for _ in 0..1000 {
            let _config = create_test_config(vec![
                ("ai.provider", "openai"),
                ("sync.correlation_threshold", "0.8"),
            ]);
        }
        
        let duration = start.elapsed();
        assert!(duration < std::time::Duration::from_millis(100));
        println!("1000 test config creations took: {:?}", duration);
    }
}
```

## 驗證標準

### 功能驗證
- [ ] config crate 依賴成功添加
- [ ] 新的配置載入函式正常工作
- [ ] 環境變數覆蓋功能正常
- [ ] CLI 參數覆蓋機制正常
- [ ] 配置來源優先級正確
- [ ] 測試配置建立器功能完整

### 相容性驗證
- [ ] 現有配置檔案格式保持相容
- [ ] 環境變數命名規則保持一致
- [ ] 配置結構體無需修改
- [ ] 向後相容性 API 正常工作

### 效能驗證
- [ ] 配置載入效能不劣於原實作
- [ ] 測試配置建立速度令人滿意
- [ ] 記憶體使用合理
- [ ] 無明顯效能倒退

## 下一步行動

完成此基礎整合階段後，將進入：
- [Backlog #21.3: 配置服務系統實作](21.3-config-service-system-implementation.md)

## 相關檔案

### 需要修改的檔案
- `Cargo.toml` - 添加依賴
- `src/config.rs` - 新增配置載入函式
- `src/error.rs` - 錯誤處理整合
- `tests/config_basic_integration.rs` - 基礎測試

### 需要分析的檔案
- `src/config/manager.rs` - 當前配置管理器
- `src/config/source.rs` - 配置來源定義
- `src/main.rs` - 主程式進入點
