# Product Backlog #19.1: 指令模組測試完善

## 領域範圍
針對指令模組 (commands/) 建立完整測試覆蓋，解決當前零覆蓋率問題，實現 60-70% 目標覆蓋率

## 背景脈絡

當前指令模組處於零測試覆蓋狀態，這是影響整體覆蓋率的關鍵因素。本 backlog 專注於：
- cache_command.rs (0% → 60%)
- config_command.rs (0% → 60%) 
- detect_encoding_command.rs (0% → 60%)
- sync_command.rs (0% → 60%)

## 完成項目

### 🔥 第一階段：基礎指令測試 (2-3 天)

#### 1.1 cache_command.rs 測試實作
**目標覆蓋率**: 0% → 60%

- [ ] **快取清理功能測試 (`clear_cache`)**
  ```rust
  #[tokio::test]
  async fn test_clear_cache_success() {
      // 建立測試快取檔案
      let temp_dir = TempDir::new().unwrap();
      let cache_path = temp_dir.path().join("cache");
      
      // 測試快取清理
      let result = clear_cache(&cache_path).await;
      assert!(result.is_ok());
      assert!(!cache_path.exists());
  }
  ```

- [ ] **快取統計顯示測試 (`show_stats`)**
  ```rust
  #[tokio::test]
  async fn test_show_cache_stats() {
      let temp_dir = TempDir::new().unwrap();
      create_test_cache_files(&temp_dir).await;
      
      let stats = show_cache_stats(&temp_dir.path()).await.unwrap();
      assert_eq!(stats.file_count, 3);
      assert!(stats.total_size > 0);
  }
  ```

- [ ] **快取檔案管理測試 (`manage_files`)**
- [ ] **錯誤處理邊界測試** (權限、檔案不存在)
- [ ] **模擬檔案系統測試環境**

#### 1.2 config_command.rs 測試實作  
**目標覆蓋率**: 0% → 60%

- [ ] **配置顯示功能測試 (`show_config`)**
  ```rust
  #[tokio::test]
  async fn test_show_config_display() {
      let config = create_test_config();
      let output = show_config(&config).await.unwrap();
      
      assert!(output.contains("ai.provider"));
      assert!(output.contains("openai"));
  }
  ```

- [ ] **配置設定功能測試 (`set_config`)**
  ```rust
  #[tokio::test]
  async fn test_set_config_value() {
      let mut config = Config::default();
      
      set_config_value(&mut config, "ai.model", "gpt-4").await.unwrap();
      assert_eq!(config.ai.model, "gpt-4");
  }
  ```

- [ ] **配置驗證功能測試 (`validate_config`)**
- [ ] **配置重置功能測試 (`reset_config`)**
- [ ] **無效配置處理測試**

#### 1.3 detect_encoding_command.rs 測試實作
**目標覆蓋率**: 0% → 60%

- [ ] **單檔案編碼檢測測試**
  ```rust
  #[tokio::test]
  async fn test_detect_single_file_encoding() {
      let temp_dir = TempDir::new().unwrap();
      let utf8_file = create_utf8_subtitle_file(&temp_dir).await;
      
      let result = detect_file_encoding(&utf8_file).await.unwrap();
      assert_eq!(result.encoding, Charset::Utf8);
      assert!(result.confidence > 0.9);
  }
  ```

- [ ] **批量編碼檢測測試**
  ```rust
  #[tokio::test]
  async fn test_batch_encoding_detection() {
      let temp_dir = TempDir::new().unwrap();
      let files = create_mixed_encoding_files(&temp_dir).await;
      
      let results = detect_batch_encoding(&files).await.unwrap();
      assert_eq!(results.len(), files.len());
      
      // 驗證不同編碼檢測結果
      assert!(results.iter().any(|r| r.encoding == Charset::Utf8));
      assert!(results.iter().any(|r| r.encoding == Charset::Gbk));
  }
  ```

- [ ] **編碼轉換建議測試**
- [ ] **不支援格式處理測試**
- [ ] **檔案讀取錯誤處理測試**

#### 1.4 sync_command.rs 測試實作
**目標覆蓋率**: 0% → 60%

- [ ] **音訊同步流程測試**
  ```rust
  #[tokio::test]
  async fn test_audio_sync_workflow() {
      let temp_dir = TempDir::new().unwrap();
      let audio_file = create_test_audio_file(&temp_dir).await;
      let subtitle_file = create_test_subtitle_file(&temp_dir).await;
      
      let result = sync_audio_subtitle(&audio_file, &subtitle_file, SyncConfig::default()).await;
      assert!(result.is_ok());
      
      let sync_result = result.unwrap();
      assert!(sync_result.confidence > 0.7);
      assert!(!sync_result.adjustments.is_empty());
  }
  ```

- [ ] **同步參數驗證測試**
- [ ] **同步結果輸出測試**
- [ ] **不匹配檔案處理測試**
- [ ] **同步失敗恢復測試**

### 🛠️ 第二階段：CLI 參數模組補齊 (1-2 天)

#### 2.1 config_args.rs 測試實作
**目標覆蓋率**: 30% → 70%

- [ ] **配置路徑參數驗證**
  ```rust
  #[test]
  fn test_config_path_validation() {
      let args = ConfigArgs {
          config_path: Some("/invalid/path".into()),
          ..Default::default()
      };
      
      let result = args.validate();
      assert!(result.is_err());
      assert!(result.unwrap_err().to_string().contains("配置檔案不存在"));
  }
  ```

- [ ] **設定值格式驗證**
- [ ] **無效參數錯誤處理**
- [ ] **多個配置選項組合測試**

#### 2.2 detect_encoding_args.rs 測試實作
**目標覆蓋率**: 0% → 70%

- [ ] **編碼檢測參數驗證**
- [ ] **輸出格式選項測試**  
- [ ] **批量處理標誌測試**
- [ ] **參數衝突檢測測試**

### 🎯 第三階段：UI 模組覆蓋率提升 (1 天)

#### 3.1 ui.rs 測試擴充
**目標覆蓋率**: 31.75% → 50%

- [ ] **表格輸出格式測試**
  ```rust
  #[test]
  fn test_table_formatting() {
      let data = vec![
          ("檔案", "編碼", "信心值"),
          ("test.srt", "UTF-8", "0.95"),
      ];
      
      let table = format_table(&data);
      assert!(table.contains("UTF-8"));
      assert!(table.contains("0.95"));
  }
  ```

- [ ] **進度條顯示邏輯測試**
- [ ] **錯誤訊息格式化測試**
- [ ] **顏色輸出功能測試**
- [ ] **終端寬度適應測試**

## 📊 實作指南

### 測試檔案結構
```
tests/
├── commands/
│   ├── cache_command_tests.rs      # 快取指令測試
│   ├── config_command_tests.rs     # 配置指令測試  
│   ├── detect_encoding_tests.rs    # 編碼檢測測試
│   └── sync_command_tests.rs       # 同步指令測試
└── cli/
    ├── config_args_tests.rs        # 配置參數測試
    ├── detect_encoding_args_tests.rs # 編碼參數測試
    └── ui_tests.rs                  # UI 模組測試
```

### 測試輔助工具
```rust
// tests/common/command_helpers.rs
pub async fn create_test_config() -> Config {
    Config {
        ai: AIConfig {
            provider: AIProvider::OpenAI,
            model: "gpt-4".to_string(),
            api_key: "test-key".to_string(),
        },
        // ... 其他配置
    }
}

pub async fn create_test_cache_files(dir: &TempDir) -> Vec<PathBuf> {
    let files = vec!["cache1.json", "cache2.json", "cache3.json"];
    let mut paths = Vec::new();
    
    for file in files {
        let path = dir.path().join(file);
        fs::write(&path, "test data").await.unwrap();
        paths.push(path);
    }
    
    paths
}
```

## 📈 預期成果

### 覆蓋率目標
- **cache_command.rs**: 0% → 60%
- **config_command.rs**: 0% → 60%  
- **detect_encoding_command.rs**: 0% → 60%
- **sync_command.rs**: 0% → 60%
- **CLI 參數模組**: 平均提升到 70%

### 測試數量
- **新增測試**: ~40 個
- **測試檔案**: ~8 個
- **預計執行時間**: +5-8 秒

## 🎯 成功標準

1. **所有指令模組達到 60% 覆蓋率**
2. **CLI 參數模組達到 70% 覆蓋率**  
3. **所有測試穩定通過**
4. **測試執行時間 <30 秒**

---

**建立日期**: 2025-06-09  
**預期完成**: 2025-06-12 (3 天)  
**前置條件**: 基礎測試環境設定完成  
**後續工作**: [#19.2 音訊與編碼測試](19.2-audio-encoding-testing.md)
