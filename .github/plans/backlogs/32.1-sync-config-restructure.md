# Backlog 32.1: 新同步配置結構設計

## 概覽

重新設計 SubX 的同步配置結構，移除基於包絡頻譜分析的舊設定，建立支援 OpenAI Whisper API 和本地 VAD 的新配置架構。這是 [Backlog 32](./32-redesign-sync-command-architecture.md) 的第一個子任務。

## 目標

1. 完全移除舊的 `[sync]` 配置項目
2. 設計新的配置結構支援雙重同步方法
3. 實作配置驗證和預設值
4. 更新配置文檔
5. 確保與現有配置系統的整合

## 技術規格

### 需要移除的舊配置項目

從 `src/config/mod.rs` 中的 `SyncConfig` 結構體移除以下欄位：
- `correlation_threshold: f32`
- `dialogue_detection_threshold: f32` 
- `min_dialogue_duration_ms: u32`
- `dialogue_merge_gap_ms: u32`
- `enable_dialogue_detection: bool`
- `audio_sample_rate: u32`
- `auto_detect_sample_rate: bool`

### 新配置結構設計

```rust
/// 音訊同步配置，支援多種同步方法
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct SyncConfig {
    /// 預設同步方法 ("whisper", "vad")
    pub default_method: String,
    /// 分析時間窗口：第一句字幕前後的秒數
    pub analysis_window_seconds: u32,
    /// 最大允許的時間偏移量（秒）
    pub max_offset_seconds: f32,
    /// Whisper API 相關設定
    pub whisper: WhisperConfig,
    /// 本地 VAD 相關設定
    pub vad: VadConfig,
}

/// OpenAI Whisper API 配置
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct WhisperConfig {
    /// 是否啟用 Whisper API 方法
    pub enabled: bool,
    /// Whisper 模型名稱
    pub model: String,
    /// 語言設定 ("auto" 為自動檢測)
    pub language: String,
    /// API 溫度參數 (0.0-1.0)
    pub temperature: f32,
    /// API 請求超時時間（秒）
    pub timeout_seconds: u32,
    /// 最大重試次數
    pub max_retries: u32,
    /// 重試間隔（毫秒）
    pub retry_delay_ms: u64,
    /// 當 Whisper 失敗時是否回退到 VAD
    pub fallback_to_vad: bool,
    /// 最低信心度閾值，低於此值回退到 VAD
    pub min_confidence_threshold: f32,
}

/// 本地 Voice Activity Detection 配置
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct VadConfig {
    /// 是否啟用本地 VAD 方法
    pub enabled: bool,
    /// 語音檢測敏感度 (0.0-1.0)
    pub sensitivity: f32,
    /// 音訊塊大小（樣本數）
    pub chunk_size: usize,
    /// 處理採樣率（Hz）
    pub sample_rate: u32,
    /// 語音檢測前後填充塊數
    pub padding_chunks: u32,
    /// 最小語音持續時間（毫秒）
    pub min_speech_duration_ms: u32,
    /// 語音段合併間隔（毫秒）
    pub speech_merge_gap_ms: u32,
}
```

### 預設值定義

```rust
impl Default for SyncConfig {
    fn default() -> Self {
        Self {
            default_method: "whisper".to_string(),
            analysis_window_seconds: 30,
            max_offset_seconds: 60.0,
            whisper: WhisperConfig::default(),
            vad: VadConfig::default(),
        }
    }
}

impl Default for WhisperConfig {
    fn default() -> Self {
        Self {
            enabled: true,
            model: "whisper-1".to_string(),
            language: "auto".to_string(),
            temperature: 0.0,
            timeout_seconds: 30,
            max_retries: 3,
            retry_delay_ms: 1000,
            fallback_to_vad: true,
            min_confidence_threshold: 0.7,
        }
    }
}

impl Default for VadConfig {
    fn default() -> Self {
        Self {
            enabled: true,
            sensitivity: 0.75,
            chunk_size: 512,
            sample_rate: 16000,
            padding_chunks: 3,
            min_speech_duration_ms: 100,
            speech_merge_gap_ms: 200,
        }
    }
}
```

## 實作步驟

### 步驟 1: 更新配置結構定義

**檔案**: `src/config/mod.rs`

```rust
// 在現有的 SyncConfig 之前先註解掉舊的實作
// TODO: Remove old SyncConfig after migration completed

/// 新的音訊同步配置結構
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct SyncConfig {
    pub default_method: String,
    pub analysis_window_seconds: u32,
    pub max_offset_seconds: f32,
    pub whisper: WhisperConfig,
    pub vad: VadConfig,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct WhisperConfig {
    pub enabled: bool,
    pub model: String,
    pub language: String,
    pub temperature: f32,
    pub timeout_seconds: u32,
    pub max_retries: u32,
    pub retry_delay_ms: u64,
    pub fallback_to_vad: bool,
    pub min_confidence_threshold: f32,
}

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct VadConfig {
    pub enabled: bool,
    pub sensitivity: f32,
    pub chunk_size: usize,
    pub sample_rate: u32,
    pub padding_chunks: u32,
    pub min_speech_duration_ms: u32,
    pub speech_merge_gap_ms: u32,
}

// 實作 Default traits...
```

### 步驟 2: 建立配置驗證器

**檔案**: `src/config/validator.rs`

```rust
use super::{SyncConfig, WhisperConfig, VadConfig};
use crate::error::SubXError;
use crate::Result;

impl SyncConfig {
    /// 驗證同步配置的有效性
    pub fn validate(&self) -> Result<()> {
        // 驗證 default_method
        match self.default_method.as_str() {
            "whisper" | "vad" => {},
            _ => return Err(SubXError::config_validation(
                "sync.default_method must be one of: whisper, vad"
            )),
        }

        // 驗證 analysis_window_seconds
        if self.analysis_window_seconds == 0 || self.analysis_window_seconds > 300 {
            return Err(SubXError::config_validation(
                "sync.analysis_window_seconds must be between 1 and 300"
            ));
        }

        // 驗證 max_offset_seconds
        if self.max_offset_seconds <= 0.0 || self.max_offset_seconds > 3600.0 {
            return Err(SubXError::config_validation(
                "sync.max_offset_seconds must be between 0.1 and 3600.0"
            ));
        }

        // 驗證子配置
        self.whisper.validate()?;
        self.vad.validate()?;

        Ok(())
    }
}

impl WhisperConfig {
    pub fn validate(&self) -> Result<()> {
        // 驗證 temperature
        if self.temperature < 0.0 || self.temperature > 1.0 {
            return Err(SubXError::config_validation(
                "sync.whisper.temperature must be between 0.0 and 1.0"
            ));
        }

        // 驗證 timeout_seconds
        if self.timeout_seconds == 0 || self.timeout_seconds > 300 {
            return Err(SubXError::config_validation(
                "sync.whisper.timeout_seconds must be between 1 and 300"
            ));
        }

        // 驗證 max_retries
        if self.max_retries > 10 {
            return Err(SubXError::config_validation(
                "sync.whisper.max_retries must be 10 or less"
            ));
        }

        // 驗證 min_confidence_threshold
        if self.min_confidence_threshold < 0.0 || self.min_confidence_threshold > 1.0 {
            return Err(SubXError::config_validation(
                "sync.whisper.min_confidence_threshold must be between 0.0 and 1.0"
            ));
        }

        Ok(())
    }
}

impl VadConfig {
    pub fn validate(&self) -> Result<()> {
        // 驗證 sensitivity
        if self.sensitivity < 0.0 || self.sensitivity > 1.0 {
            return Err(SubXError::config_validation(
                "sync.vad.sensitivity must be between 0.0 and 1.0"
            ));
        }

        // 驗證 chunk_size (must be power of 2 and reasonable size)
        if self.chunk_size < 256 || self.chunk_size > 2048 || !self.chunk_size.is_power_of_two() {
            return Err(SubXError::config_validation(
                "sync.vad.chunk_size must be a power of 2 between 256 and 2048"
            ));
        }

        // 驗證 sample_rate
        match self.sample_rate {
            8000 | 16000 | 32000 | 44100 | 48000 => {},
            _ => return Err(SubXError::config_validation(
                "sync.vad.sample_rate must be one of: 8000, 16000, 32000, 44100, 48000"
            )),
        }

        Ok(())
    }
}
```

### 步驟 3: 更新測試

**檔案**: `src/config/mod.rs` (tests 模組)

```rust
#[cfg(test)]
mod config_tests {
    use super::*;

    #[test]
    fn test_new_sync_config_defaults() {
        let sync = SyncConfig::default();
        assert_eq!(sync.default_method, "whisper");
        assert_eq!(sync.analysis_window_seconds, 30);
        assert_eq!(sync.max_offset_seconds, 60.0);
        assert!(sync.whisper.enabled);
        assert!(sync.whisper.fallback_to_vad);
        assert_eq!(sync.whisper.min_confidence_threshold, 0.7);
        assert!(sync.vad.enabled);
    }

    #[test]
    fn test_sync_config_validation() {
        let mut sync = SyncConfig::default();
        
        // 有效配置應該通過驗證
        assert!(sync.validate().is_ok());
        
        // 無效的 default_method
        sync.default_method = "invalid".to_string();
        assert!(sync.validate().is_err());
        
        // 重置並測試其他無效值
        sync = SyncConfig::default();
        sync.analysis_window_seconds = 0;
        assert!(sync.validate().is_err());
        
        sync = SyncConfig::default();
        sync.max_offset_seconds = -1.0;
        assert!(sync.validate().is_err());
    }

    #[test]
    fn test_whisper_config_validation() {
        let mut whisper = WhisperConfig::default();
        
        // 有效配置
        assert!(whisper.validate().is_ok());
        
        // 無效溫度
        whisper.temperature = 2.0;
        assert!(whisper.validate().is_err());
        
        // 無效超時時間
        whisper = WhisperConfig::default();
        whisper.timeout_seconds = 0;
        assert!(whisper.validate().is_err());
        
        // 無效信心度閾值
        whisper = WhisperConfig::default();
        whisper.min_confidence_threshold = 1.5;
        assert!(whisper.validate().is_err());
    }

    #[test]
    fn test_vad_config_validation() {
        let mut vad = VadConfig::default();
        
        // 有效配置
        assert!(vad.validate().is_ok());
        
        // 無效敏感度
        vad.sensitivity = 1.5;
        assert!(vad.validate().is_err());
        
        // 無效 chunk_size (不是 2 的冪次)
        vad = VadConfig::default();
        vad.chunk_size = 500;
        assert!(vad.validate().is_err());
        
        // 無效取樣率
        vad = VadConfig::default();
        vad.sample_rate = 22050;
        assert!(vad.validate().is_err());
    }

    #[test]
    fn test_config_serialization_with_new_sync() {
        let config = Config::default();
        let toml_str = toml::to_string(&config).unwrap();
        
        // 確保新的配置結構存在於序列化輸出中
        assert!(toml_str.contains("[sync]"));
        assert!(toml_str.contains("[sync.whisper]"));
        assert!(toml_str.contains("[sync.vad]"));
        assert!(toml_str.contains("default_method"));
        assert!(toml_str.contains("analysis_window_seconds"));
    }
}
```

### 步驟 4: 更新 TestConfigBuilder

**檔案**: `src/config/builder.rs`

```rust
impl TestConfigBuilder {
    /// 設定同步方法
    pub fn with_sync_method(mut self, method: &str) -> Self {
        self.sync.default_method = method.to_string();
        self
    }

    /// 設定分析時間窗口
    pub fn with_analysis_window(mut self, seconds: u32) -> Self {
        self.sync.analysis_window_seconds = seconds;
        self
    }

    /// 啟用/停用 Whisper API
    pub fn with_whisper_enabled(mut self, enabled: bool) -> Self {
        self.sync.whisper.enabled = enabled;
        self
    }

    /// 設定 Whisper 模型
    pub fn with_whisper_model(mut self, model: &str) -> Self {
        self.sync.whisper.model = model.to_string();
        self
    }

    /// 啟用/停用本地 VAD
    pub fn with_vad_enabled(mut self, enabled: bool) -> Self {
        self.sync.vad.enabled = enabled;
        self
    }

    /// 設定 VAD 敏感度
    pub fn with_vad_sensitivity(mut self, sensitivity: f32) -> Self {
        self.sync.vad.sensitivity = sensitivity;
        self
    }

    /// 設定 VAD 取樣率
    pub fn with_vad_sample_rate(mut self, sample_rate: u32) -> Self {
        self.sync.vad.sample_rate = sample_rate;
        self
    }
}
```

## 測試策略

### 單元測試

1. **配置預設值測試**: 驗證所有預設值符合預期
2. **配置驗證測試**: 測試各種無效配置應該被拒絕
3. **序列化測試**: 確保新配置結構可以正確序列化/反序列化
4. **環境變數測試**: 驗證環境變數可以正確覆蓋配置值

### 整合測試

1. **配置檔案載入測試**: 測試從 TOML 檔案載入新配置結構
2. **向後兼容性測試**: 確保舊配置檔案會產生適當的錯誤訊息
3. **TestConfigBuilder 測試**: 驗證測試建構器支援新配置

### 測試檔案位置

- `tests/config_new_sync_structure_tests.rs` - 新配置結構的整合測試
- `src/config/mod.rs` - 單元測試在模組內部
- `tests/config_migration_tests.rs` - 遷移和兼容性測試

## 檔案變更清單

### 需要修改的檔案

1. `src/config/mod.rs` - 主要配置結構定義
2. `src/config/validator.rs` - 配置驗證邏輯
3. `src/config/builder.rs` - 測試建構器更新
4. `src/config/environment.rs` - 環境變數支援（如需要）
5. `docs/configuration-guide.md` - 配置文檔更新

### 需要建立的檔案

1. `tests/config_new_sync_structure_tests.rs` - 新配置結構測試
2. `tests/config_migration_tests.rs` - 配置遷移測試

## 完成標準

1. ✅ 新的 `SyncConfig`、`WhisperConfig`、`VadConfig` 結構體已定義且正常運作
2. ✅ 所有配置驗證邏輯已實作並測試
3. ✅ 預設值符合規格要求
4. ✅ 環境變數支援正常運作
5. ✅ TestConfigBuilder 支援新配置結構
6. ✅ 所有單元測試和整合測試通過
7. ✅ 配置檔案可以正確序列化/反序列化為 TOML 格式
8. ✅ 舊配置結構已標記為 deprecated（在完全移除前）

## 風險評估

### 高風險
- **Breaking Changes**: 舊配置檔案將無法使用，需要提供清晰的遷移指導

### 中風險  
- **複雜性增加**: 新的嵌套配置結構可能增加使用者理解難度
- **環境變數命名**: 需要確保環境變數命名一致且直觀

### 低風險
- **序列化問題**: TOML 序列化應該相對簡單
- **測試覆蓋**: 現有的測試基礎設施應該足夠

## 後續步驟

完成此 backlog 後：
1. 繼續實作 [Backlog 32.2: OpenAI Whisper API 整合](./32.2-whisper-api-integration.md)
2. 確保新配置結構與後續實作的同步引擎正確整合
3. 準備使用者配置遷移指南

---

**預估工時**: 8 小時  
**完成日期**: TBD  
**依賴項目**: 無  
**後續項目**: Backlog 32.2
