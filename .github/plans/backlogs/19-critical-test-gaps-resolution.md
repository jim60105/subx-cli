# Product Backlog #19: 關鍵測試缺口解決方案

## 領域範圍
解決測試覆蓋率提升計畫 (#18) 審查後發現的關鍵缺口、達成 75% 整體覆蓋率目標、完善剩餘未覆蓋的核心功能測試

## 背景脈絡

基於 [測試覆蓋率提升計畫審查報告 (#60)](.github/codex/60-test-coverage-enhancement-review-report.md) 的分析結果，目前整體覆蓋率為 70.22%，距離 75% 目標尚有 4.78% 的差距。本 backlog 針對審查中發現的關鍵缺口制定具體解決方案。

### 當前狀態
- **整體覆蓋率**: 70.22% / 75% (目標)
- **函式覆蓋率**: 62.41% (需提升)
- **區域覆蓋率**: 59.01% (需提升)
- **測試數量**: 107 個 (穩定)

### 主要問題
1. **指令模組零覆蓋**: cache_command, config_command, detect_encoding_command, sync_command
2. **音訊服務不足**: audio/analyzer.rs 僅 6.93% 覆蓋率
3. **編碼檢測空白**: encoding/analyzer.rs 和相關模組 0% 覆蓋率
4. **同步功能缺失**: sync/engine.rs, dialogue/detector.rs 等核心功能

## 完成項目

### 🔥 第一階段：立即優先級 (1-2 天) - 預期覆蓋率提升 +3%

#### 1.1 指令模組測試補完 (目標覆蓋率: 60%)
- [ ] **cache_command.rs 測試實作**
  - [ ] 快取清理功能測試 (`clear_cache`)
  - [ ] 快取統計顯示測試 (`show_stats`)
  - [ ] 快取檔案管理測試 (`manage_files`)
  - [ ] 錯誤處理邊界測試 (權限、檔案不存在)
  - [ ] 模擬檔案系統測試環境

- [ ] **config_command.rs 測試實作**
  - [ ] 配置顯示功能測試 (`show_config`)
  - [ ] 配置設定功能測試 (`set_config`)
  - [ ] 配置驗證功能測試 (`validate_config`)
  - [ ] 配置重置功能測試 (`reset_config`)
  - [ ] 無效配置處理測試

- [ ] **detect_encoding_command.rs 測試實作**
  - [ ] 單檔案編碼檢測測試
  - [ ] 批量編碼檢測測試
  - [ ] 編碼轉換建議測試
  - [ ] 不支援格式處理測試
  - [ ] 檔案讀取錯誤處理測試

- [ ] **sync_command.rs 測試實作**
  - [ ] 音訊同步流程測試
  - [ ] 同步參數驗證測試
  - [ ] 同步結果輸出測試
  - [ ] 不匹配檔案處理測試
  - [ ] 同步失敗恢復測試

#### 1.2 CLI 參數模組補齊 (目標覆蓋率: 70%)
- [ ] **config_args.rs 測試實作**
  - [ ] 配置路徑參數驗證
  - [ ] 設定值格式驗證
  - [ ] 無效參數錯誤處理
  - [ ] 多個配置選項組合測試

- [ ] **detect_encoding_args.rs 測試實作**
  - [ ] 編碼檢測參數驗證
  - [ ] 輸出格式選項測試
  - [ ] 批量處理標誌測試
  - [ ] 參數衝突檢測測試

#### 1.3 UI 模組覆蓋率提升 (目標覆蓋率: 50%)
- [ ] **ui.rs 測試擴充**
  - [ ] 表格輸出格式測試
  - [ ] 進度條顯示邏輯測試
  - [ ] 錯誤訊息格式化測試
  - [ ] 顏色輸出功能測試
  - [ ] 終端寬度適應測試

### ⚡ 第二階段：中期優先級 (3-5 天) - 預期覆蓋率提升 +2%

#### 2.1 音訊服務測試重建 (目標覆蓋率: 60%)
- [ ] **audio/analyzer.rs 測試實作 (當前 6.93% → 60%)**
  - [ ] 音訊檔案載入測試
  - [ ] 音訊格式支援驗證
  - [ ] 音訊屬性分析測試 (採樣率、聲道)
  - [ ] 音訊長度計算測試
  - [ ] 損壞檔案處理測試
  - [ ] 記憶體使用量測試

- [ ] **audio/extractor.rs 測試補充**
  - [ ] 音訊資料提取測試
  - [ ] 時間戳記對應測試
  - [ ] 音訊轉換測試
  - [ ] 批量處理測試

- [ ] **audio/ 相關模組整合測試**
  - [ ] AUS 音訊處理引擎整合測試
  - [ ] 音訊服務端到端測試
  - [ ] 效能基準測試

#### 2.2 編碼檢測功能測試建立 (目標覆蓋率: 70%)
- [ ] **encoding/analyzer.rs 測試實作 (當前 0% → 70%)**
  - [ ] 編碼檢測算法測試
  - [ ] 信心值計算測試
  - [ ] 多語言編碼支援測試
  - [ ] BOM 檢測測試
  - [ ] 編碼轉換驗證測試

- [ ] **encoding/detector.rs 測試實作**
  - [ ] 自動編碼檢測測試
  - [ ] 編碼優先級測試
  - [ ] 編碼衝突解決測試

#### 2.3 AI 重試機制測試完善 (目標覆蓋率: 80%)
- [ ] **ai/retry.rs 測試實作 (當前 0% → 80%)**
  - [ ] 重試策略邏輯測試
  - [ ] 指數退避算法測試
  - [ ] 最大重試次數測試
  - [ ] 重試條件判斷測試
  - [ ] 重試狀態追蹤測試

### 🎯 第三階段：長期優先級 (1-2 週) - 預期覆蓋率提升 +2%

#### 3.1 同步功能測試體系建立 (目標覆蓋率: 65%)
- [ ] **sync/engine.rs 測試實作 (當前 0% → 65%)**
  - [ ] 時間軸同步算法測試
  - [ ] 音訊與字幕對齊測試
  - [ ] 同步品質評估測試
  - [ ] 手動調整功能測試
  - [ ] 同步結果驗證測試

- [ ] **sync/dialogue/detector.rs 測試實作**
  - [ ] 對話檢測算法測試
  - [ ] 語音活動檢測測試
  - [ ] 靜音區間檢測測試
  - [ ] 對話分段測試

- [ ] **sync/dialogue/matcher.rs 測試實作**
  - [ ] 對話匹配邏輯測試
  - [ ] 相似度計算測試
  - [ ] 匹配信心值測試
  - [ ] 批量匹配測試

#### 3.2 核心模組覆蓋率提升
- [ ] **core/parallel/worker.rs 提升 (32.28% → 70%)**
  - [ ] 工作分配邏輯測試
  - [ ] 錯誤恢復機制測試
  - [ ] 並行處理效能測試
  - [ ] 資源管理測試

- [ ] **config/validator.rs 提升 (18.25% → 70%)**
  - [ ] 配置檔案驗證測試
  - [ ] 格式驗證邏輯測試
  - [ ] 驗證錯誤報告測試
  - [ ] 跨平台驗證測試

#### 3.3 整合測試擴充與效能測試
- [ ] **端到端工作流程測試**
  - [ ] 完整字幕處理流程測試
  - [ ] 配置載入到執行測試
  - [ ] 錯誤處理鏈測試
  - [ ] 使用者情境測試

- [ ] **效能基準測試添加**
  - [ ] 大檔案處理效能測試
  - [ ] 記憶體使用量基準測試
  - [ ] 並行處理效能測試
  - [ ] 回歸效能測試

### 🛠️ 第四階段：測試基礎設施優化

#### 4.1 測試工具增強
- [ ] **CLI 測試輔助工具**
  - [ ] 指令列參數測試輔助函式
  - [ ] 輸出捕獲與驗證工具
  - [ ] 臨時檔案管理工具

- [ ] **模擬服務擴充**
  - [ ] 音訊檔案模擬器
  - [ ] 檔案系統模擬器增強
  - [ ] 網路服務模擬器

- [ ] **測試資料產生器升級**
  - [ ] 各種格式字幕檔案產生器
  - [ ] 音訊檔案測試資料產生器
  - [ ] 異常情境測試資料

#### 4.2 覆蓋率監控與報告
- [ ] **自動化覆蓋率檢查**
  - [ ] CI/CD 覆蓋率門檻檢查
  - [ ] 覆蓋率趨勢追蹤
  - [ ] 覆蓋率回歸警告

- [ ] **詳細覆蓋率報告**
  - [ ] 模組層級覆蓋率報告
  - [ ] 函式層級覆蓋率分析
  - [ ] 未覆蓋代碼清單

## 📊 預期成果

### 覆蓋率目標
- **整體覆蓋率**: 70.22% → 78% (+7.78%)
- **函式覆蓋率**: 62.41% → 72% (+9.59%)
- **區域覆蓋率**: 59.01% → 68% (+8.99%)

### 模組覆蓋率目標
- **指令模組**: 0-30% → 60-70%
- **音訊服務**: 6.93% → 60%
- **編碼檢測**: 0% → 70%
- **同步功能**: 0% → 65%

### 品質指標
- **測試穩定性**: 維持 100% 通過率
- **測試執行時間**: <30 秒 (當前 <20 秒)
- **程式碼品質**: 維持零 clippy 警告

## 🎯 成功標準

### 主要指標
1. **整體覆蓋率達到 78%** (超越原定 75% 目標)
2. **所有指令模組覆蓋率 >60%**
3. **音訊服務覆蓋率 >60%**
4. **編碼檢測覆蓋率 >70%**

### 次要指標
1. **測試執行穩定性 100%**
2. **新增測試 >80 個**
3. **程式碼品質維持零警告**
4. **測試執行時間 <30 秒**

## 🚀 實作策略

### 優先級排序原則
1. **影響範圍**: 優先處理影響覆蓋率最大的模組
2. **使用頻率**: 優先測試最常用的功能
3. **錯誤風險**: 優先覆蓋高風險錯誤情境
4. **實作難度**: 先易後難，建立成功慣性

### 測試設計原則
1. **邊界值測試**: 包含正常、邊界、異常情境
2. **錯誤處理**: 充分測試各種錯誤情境
3. **整合驗證**: 確保模組間互動正確
4. **效能考量**: 關鍵路徑添加效能測試

### 品質保證流程
1. **測試前檢查**: `cargo fmt` + `cargo clippy`
2. **測試驗證**: 所有測試必須通過
3. **覆蓋率驗證**: 達到模組目標覆蓋率
4. **檔案追蹤**: 記錄所有測試檔案變更

## 🔄 後續維護

### 持續監控
- **每次 commit 覆蓋率檢查**
- **週期性覆蓋率報告**
- **新功能測試覆蓋率要求**

### 測試更新策略
- **功能變更時同步更新測試**
- **定期檢查測試有效性**
- **過時測試清理與重構**

---

**建立日期**: 2025-06-09  
**基於審查**: [測試覆蓋率提升計畫審查報告 (#60)](../.github/codex/60-test-coverage-enhancement-review-report.md)  
**預期完成**: 2025-06-23 (2 週)  
**負責範圍**: 測試覆蓋率缺口解決、品質提升、測試基礎設施完善
