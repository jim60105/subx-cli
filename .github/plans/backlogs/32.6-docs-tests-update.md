# Backlog 32.6: 文檔和測試更新

## 概覽

作為 Sync 指令架構重新設計的最後階段，本 backlog 涵蓋所有相關文檔的更新和完整測試套件的建立。確保新的同步功能有完整的文檔支援和測試覆蓋。

## 目標

1. 更新 `docs/configuration-guide.md` 以反映新的 sync 配置結構
2. 更新技術架構文檔
3. 建立針對新同步功能的完整測試套件
4. 創建使用者遷移指南
5. 更新 CLI 幫助文檔和範例

## 詳細需求

### 1. 配置指南更新

**檔案**: `docs/configuration-guide.md`

需要完全重寫 `[sync]` 配置節段，包括：

```toml
# 舊配置（需要移除）
[sync]
max_offset_seconds = 10.0
correlation_threshold = 0.8
dialogue_detection_threshold = 0.6
min_dialogue_duration_ms = 500
dialogue_merge_gap_ms = 200
enable_dialogue_detection = true
audio_sample_rate = 44100
auto_detect_sample_rate = true

# 新配置結構
[sync]
# 基本設定
default_method = "whisper"           # 預設同步方法: whisper, vad
analysis_window_seconds = 30        # 分析時間窗口（第一句前後秒數）
max_offset_seconds = 60.0           # 最大允許偏移量

# Whisper API 設定
[sync.whisper]
enabled = true                       # 啟用 Whisper API 方法
model = "whisper-1"                 # Whisper 模型選擇
language = "auto"                   # 語言設定，auto 為自動檢測
temperature = 0.0                   # API 溫度參數
timeout_seconds = 30                # API 超時時間
max_retries = 3                     # 最大重試次數
retry_delay_ms = 1000               # 重試延遲時間（毫秒）

# 本地 VAD 設定
[sync.vad]
enabled = true                      # 啟用本地 VAD 方法
sensitivity = 0.75                  # 語音檢測敏感度 (0.0-1.0)
chunk_size = 512                   # 音訊塊大小
sample_rate = 16000                # 處理採樣率
padding_chunks = 3                 # 語音檢測前後填充塊數
min_speech_duration_ms = 100       # 最小語音持續時間（毫秒）
speech_merge_gap_ms = 200          # 語音段合併間隔（毫秒）
```

**文檔更新要求**:
- 新增方法選擇說明（whisper vs vad vs manual）
- 詳細說明每個配置參數的用途和有效範圍
- 提供使用場景建議（何時使用哪種方法）
- 新增故障排除節段和 API 配額管理指南
- 包含效能調優建議和成本考量說明
- 說明分析時間窗口為「第一句字幕前後 30 秒（共 60 秒）」的工作原理

### 2. 技術架構文檔更新

**檔案**: `docs/tech-architecture.md`

更新音訊同步架構節段：
- 移除包絡頻譜分析相關內容
- 新增 Whisper API 整合架構圖
- 新增本地 VAD 處理流程
- 更新同步引擎類別圖
- 新增錯誤處理和回退機制說明

### 3. 使用者遷移指南

**新檔案**: `docs/sync-migration-guide.md`

內容包括：
- 舊配置與新配置的對應關係
- 步驟化的遷移指南
- 常見問題和解決方案
- 效能期望和調優建議

### 4. CLI 幫助文檔更新

更新 `src/cli/sync_args.rs` 中的幫助文字，包括：

```rust
// 新的 CLI 參數範例
/// Synchronize subtitles with audio using AI-powered methods
#[derive(Debug, Clone, Parser)]
pub struct SyncArgs {
    /// Video file path for audio analysis
    pub video: PathBuf,

    /// Subtitle file path to be synchronized
    pub subtitle: PathBuf,

    /// Output synchronized subtitle file path (optional, defaults to input with .synced suffix)
    #[arg(short, long)]
    pub output: Option<PathBuf>,

    /// Manual offset in seconds (conflicts with detection methods)
    #[arg(
        long,
        conflicts_with_all = ["method", "window", "whisper_model", "whisper_language", "vad_sensitivity"]
    )]
    pub offset: Option<f32>,

    /// Synchronization method
    #[arg(
        short,
        long,
        value_enum,
        help = "Synchronization method to use",
        long_help = "Select the synchronization method:\n\
                     • whisper (default): Use OpenAI Whisper API with intelligent VAD fallback\n\
                     • whisper: Use OpenAI Whisper API for transcription-based sync\n\
                     • vad: Use local Voice Activity Detection\n\
                     • manual: Apply manual offset (requires --offset)"
    )]
    pub method: Option<SyncMethodArg>,

    /// Analysis time window in seconds (audio around first subtitle)
    #[arg(
        short = 'w',
        long,
        value_name = "SECONDS",
        default_value = "30",
        help = "Time window in seconds to analyze around the first subtitle"
    )]
    pub window: u32,

    /// Maximum allowed offset in seconds
    #[arg(long, default_value = "60.0")]
    pub max_offset: f64,

    /// Whisper model to use (when method=whisper)
    #[arg(long, default_value = "whisper-1")]
    pub whisper_model: String,

    /// Whisper API language (auto for auto-detection)
    #[arg(long, default_value = "auto")]
    pub whisper_language: String,

    /// VAD sensitivity (0.0-1.0, when method=vad)
    #[arg(long, default_value = "0.75")]
    pub vad_sensitivity: f64,

    /// Dry run mode - show what would be done without making changes
    #[arg(long)]
    pub dry_run: bool,

    /// Enable batch processing mode
    #[arg(long)]
    pub batch: bool,
}

#[derive(Debug, Clone, ValueEnum)]
pub enum SyncMethodArg {
    Whisper,
    Vad,
    Manual,
}
```

### 5. 測試套件建立

#### 5.1 單元測試

**新檔案**: `tests/commands/sync_command_tests.rs`

```rust
// 測試結構範例
#[cfg(test)]
mod sync_command_tests {
    use super::*;
    use crate::config::test_service::TestConfigService;
    use crate::common::test_helpers::{TestFileManager, AudioMockGenerator};
    use tempfile::TempDir;
    
    #[tokio::test]
    async fn test_whisper_api_sync_basic() {
        let _config = TestConfigService::new()
            .with_sync_method("whisper")
            .with_whisper_model("whisper-1")
            .build();
        
        // 測試基本 Whisper API 同步功能
        let mut file_manager = TestFileManager::new();
        let test_dir = file_manager
            .create_isolated_test_directory("whisper_sync_test")
            .await
            .unwrap();
        
        // 建立測試檔案並執行同步測試
    }
    
    #[tokio::test]
    async fn test_local_vad_sync_basic() {
        let _config = TestConfigService::new()
            .with_sync_method("vad")
            .with_vad_sensitivity(0.75)
            .build();
        
        // 測試基本本地 VAD 同步功能
    }
    
    #[tokio::test]
    async fn test_whisper_method_with_fallback() {
        let _config = TestConfigService::new()
            .with_sync_method("whisper")
            .build();
        
        // 測試 Whisper 方法的智能回退邏輯
    }
    
    #[tokio::test]
    async fn test_sync_error_handling() {
        // 測試錯誤處理和回退機制
    }
    
    #[tokio::test]
    async fn test_sync_config_validation() {
        // 測試配置驗證
        let config = TestConfigService::new()
            .with_sync_method("invalid_method")
            .build();
        
        // 驗證無效配置會被正確處理
    }
    
    #[tokio::test]
    async fn test_manual_offset_sync() {
        let _config = TestConfigService::new()
            .with_sync_method("manual")
            .build();
        
        // 測試手動偏移同步功能
    }
}
```

#### 5.2 整合測試

**新檔案**: `tests/sync/whisper_integration_tests.rs`

```rust
// 整合測試範例
#[cfg(test)]
mod whisper_integration_tests {
    use crate::config::test_service::TestConfigService;
    use crate::common::test_helpers::{TestFileManager, AudioMockGenerator};
    
    #[tokio::test]
    async fn test_sync_command_whisper_integration() {
        let _config = TestConfigService::new()
            .with_sync_method("whisper")
            .with_whisper_model("whisper-1")
            .with_whisper_timeout(30)
            .build();
        
        // 測試完整的 Whisper API 整合流程
    }
    
    #[tokio::test]
    async fn test_whisper_api_error_handling() {
        // 測試 Whisper API 錯誤處理
    }
}
```

**新檔案**: `tests/sync/vad_integration_tests.rs`

```rust
#[cfg(test)]
mod vad_integration_tests {
    use crate::config::test_service::TestConfigService;
    
    #[tokio::test]
    async fn test_sync_command_vad_integration() {
        let _config = TestConfigService::new()
            .with_sync_method("vad")
            .with_vad_sensitivity(0.8)
            .build();
        
        // 測試完整的本地 VAD 整合流程
    }
    
    #[tokio::test]
    async fn test_vad_config_validation() {
        // 測試 VAD 配置驗證
    }
}
```

**更新檔案**: `tests/sync/integration_tests.rs`

```rust
// 更新現有的同步整合測試以配合新架構
#[cfg(test)]
mod sync_integration_tests {
    use crate::config::test_service::TestConfigService;
    
    #[tokio::test]
    async fn test_sync_command_config_loading() {
        let _config = TestConfigService::new()
            .with_sync_method("whisper")
            .with_analysis_window_seconds(30)
            .with_max_offset(60.0)
            .build();
        
        // 測試配置載入和驗證
    }
    
    #[tokio::test]
    async fn test_sync_command_cli_args() {
        // 測試 CLI 參數解析和處理
    }
    
    #[tokio::test]
    async fn test_sync_method_fallback() {
        // 測試方法回退機制（Whisper 失敗時回退到 VAD）
    }
}
```

#### 5.3 效能測試

**新檔案**: `benches/sync_performance_bench.rs`

```rust
// 效能測試範例
use criterion::{black_box, criterion_group, criterion_main, Criterion};

fn bench_whisper_api_sync(c: &mut Criterion) {
    c.bench_function("whisper_api_sync", |b| {
        b.iter(|| {
            // Whisper API 同步效能測試
        })
    });
}

fn bench_local_vad_sync(c: &mut Criterion) {
    c.bench_function("local_vad_sync", |b| {
        b.iter(|| {
            // 本地 VAD 同步效能測試
        })
    });
}

criterion_group!(benches, bench_whisper_api_sync, bench_local_vad_sync);
criterion_main!(benches);
```

### 6. 測試資料準備

建立測試資料目錄結構：

```
tests/fixtures/sync/
├── audio/
│   ├── test_audio_en.wav      # 英語測試音訊
│   ├── test_audio_zh.wav      # 中文測試音訊
│   └── test_audio_mixed.wav   # 混合語言測試音訊
├── subtitles/
│   ├── test_sub_en.srt        # 對應英語字幕
│   ├── test_sub_zh.srt        # 對應中文字幕
│   └── test_sub_mixed.srt     # 對應混合語言字幕
└── expected/
    ├── whisper_results/       # 預期 Whisper API 結果
    └── vad_results/          # 預期 VAD 結果
```

### 7. 文檔品質檢查

建立文檔品質檢查腳本：

**新檔案**: `scripts/docs_quality_check.sh`

```bash
#!/bin/bash
# 文檔品質檢查腳本

set -e

echo "🔍 檢查文檔品質..."

# 檢查 markdown 語法
echo "檢查 Markdown 語法..."
markdownlint docs/*.md || echo "⚠️  Markdown 語法問題"

# 檢查配置範例的語法
echo "檢查 TOML 配置範例..."
find docs -name "*.md" -exec grep -l "```toml" {} \; | while read file; do
    echo "檢查 $file 中的 TOML 範例..."
    # 提取並驗證 TOML 範例
done

# 檢查連結有效性
echo "檢查文檔連結..."
find docs -name "*.md" -exec markdown-link-check {} \; || echo "⚠️  連結檢查問題"

echo "✅ 文檔品質檢查完成"
```

## 實作步驟

### 階段 1: 配置文檔更新 (2 小時)
1. 備份現有 `docs/configuration-guide.md` 的 sync 節段
2. 移除舊的 sync 配置文檔
3. 撰寫新的 sync 配置節段
4. 新增使用場景和最佳實踐指南

### 階段 2: 技術文檔更新 (2 小時)
1. 更新 `docs/tech-architecture.md`
2. 新增架構圖和流程圖
3. 創建遷移指南文檔

### 階段 3: 測試套件開發 (4 小時)
1. 建立測試資料和 fixture
2. 撰寫單元測試
3. 撰寫整合測試
4. 建立效能測試基準

### 階段 4: 文檔整合和驗證 (2 小時)
1. 執行文檔品質檢查
2. 驗證所有範例程式碼可執行
3. 確保測試覆蓋率達標
4. 最終文檔審核

## 驗收標準

### 功能要求
- [ ] `docs/configuration-guide.md` 完全更新，移除舊配置，新增新配置
- [ ] `docs/tech-architecture.md` 反映新的同步架構
- [ ] 新增 `docs/sync-migration-guide.md` 遷移指南
- [ ] CLI 幫助文字準確反映新功能
- [ ] 所有新功能有對應的單元測試
- [ ] 整合測試覆蓋主要使用場景
- [ ] 效能測試提供基準數據

### 品質要求
- [ ] 測試覆蓋率 ≥ 85%
- [ ] 所有文檔通過品質檢查
- [ ] 所有範例程式碼可執行
- [ ] 文檔連結全部有效
- [ ] 遷移指南經過實際驗證

### 相容性要求
- [ ] 明確標示 breaking changes
- [ ] 提供完整的遷移路徑
- [ ] 錯誤訊息指向遷移指南
- [ ] 舊配置格式有清晰的棄用警告

## 測試策略

### 1. 配置測試
```rust
#[tokio::test]
async fn test_sync_config_structure() {
    let config = TestConfigService::new()
        .with_sync_method("whisper")
        .with_whisper_model("whisper-1")
        .with_vad_sensitivity(0.8)
        .build();
    
    assert_eq!(config.sync.default_method, "whisper");
    assert_eq!(config.sync.whisper.model, "whisper-1");
    assert_eq!(config.sync.vad.sensitivity, 0.8);
}
```

### 2. 文檔範例測試
```rust
#[test]
fn test_documentation_examples() {
    // 解析文檔中的配置範例
    let doc_examples = extract_toml_examples_from_docs();
    
    for example in doc_examples {
        // 驗證每個範例都是有效的配置
        assert!(parse_config(&example).is_ok());
    }
}
```

### 3. 遷移測試
```rust
#[test]
fn test_migration_scenarios() {
    // 測試常見的遷移場景
    let old_configs = vec![
        // 各種舊配置格式
    ];
    
    for old_config in old_configs {
        // 驗證遷移指南的有效性
        let migrated = apply_migration_guide(&old_config);
        assert!(migrated.is_valid());
    }
}
```

## 需要變更的檔案

### 文檔檔案
- `docs/configuration-guide.md` - 完全重寫 sync 節段
- `docs/tech-architecture.md` - 更新同步架構
- `docs/sync-migration-guide.md` - 新增遷移指南

### 測試檔案
- `tests/commands/sync_command_tests.rs` - 新增同步指令測試
- `tests/sync/whisper_integration_tests.rs` - 新增 Whisper API 整合測試
- `tests/sync/vad_integration_tests.rs` - 新增 VAD 整合測試
- `tests/sync/integration_tests.rs` - 更新現有同步整合測試
- `benches/sync_performance_bench.rs` - 新增效能測試

### 工具腳本
- `scripts/docs_quality_check.sh` - 新增文檔品質檢查
- `scripts/test_migration.sh` - 新增遷移測試腳本

### 測試資料
- `tests/fixtures/sync/` - 新增測試資料目錄

## 風險和緩解措施

### 文檔風險
- **風險**: 文檔與實際功能不一致
- **緩解**: 建立自動化文檔測試，驗證所有範例

### 測試風險
- **風險**: 測試覆蓋不足，遺漏邊界情況
- **緩解**: 使用測試覆蓋率工具，定期審核測試案例

### 遷移風險
- **風險**: 用戶遷移過程中遇到問題
- **緩解**: 提供詳細的故障排除指南和支援資源

## 成功指標

- 文檔品質檢查 100% 通過
- 測試覆蓋率 ≥ 85%
- 所有範例程式碼執行成功
- 遷移指南經實際驗證
- 使用者反饋正面（如果有測試使用者）
- 新的同步方法（Whisper API 和 VAD）完全整合並測試
- 所有舊的包絡頻譜分析相關文檔已移除

---

**負責人**: GitHub Copilot  
**建立日期**: 2025-06-14  
**預估工時**: 8 小時  
**優先級**: 中  
**依賴**: Backlog 32.1-32.5 完成  
**狀態**: 待開始
