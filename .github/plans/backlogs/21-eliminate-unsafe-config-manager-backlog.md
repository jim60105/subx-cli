# Backlog #21: 消除不安全配置管理器重設機制

## 概述

目前的配置系統為了支援測試隔離，使用了包含 `unsafe` 程式碼的 `reset_global_config_manager()` 函式來重設 `OnceLock<Mutex<ConfigManager>>`。這種做法破壞了 Rust 的記憶體安全保證，且新的實作人員經常不知道這個限制，導致測試競態條件問題持續發生。

本 backlog 旨在設計並實作一個完全安全的替代方案，採用社區標準的 `config` crate 結合依賴注入模式，徹底消除對 `unsafe` 程式碼的依賴。

## 核心問題

1. **記憶體安全風險**：`reset_global_config_manager()` 使用 `unsafe` 程式碼覆寫 `OnceLock`
2. **測試競態條件**：多個測試同時存取全域配置管理器造成狀態污染  
3. **維護困難**：需要在每個測試中手動添加 `#[serial]` 註解和狀態重設
4. **隱性依賴**：新開發人員不了解測試需要特殊處理的限制

## 解決方案概要

採用 **config crate + 依賴注入模式**：
- 使用成熟、維護良好的 `config` crate
- 實作 `ConfigService` 特徵介面
- 建立生產環境和測試環境的不同實作
- 透過依賴注入傳遞配置，消除全域狀態

## 子任務分解

本 backlog 已拆分為以下子任務，請按順序執行：

### [21.1 配置管理器問題分析與方案設計](21.1-config-manager-problem-analysis-design.md)
**預估時間：1 天**
- 深入分析當前配置系統問題
- 評估 config crate 整合可行性
- 設計依賴注入架構
- 制定技術遷移策略

### [21.2 config crate 整合與基礎實作](21.2-config-crate-integration-implementation.md)
**預估時間：2.5 天**
- 添加 config crate 依賴
- 實作新的配置載入機制
- 建立測試專用配置建立器
- 提供向後相容性 API

### [21.3 配置服務系統實作](21.3-config-service-system-implementation.md) 
**預估時間：3.5 天**
- 實作 ConfigService 特徵介面
- 建立生產和測試環境配置服務
- 重構應用程式進入點
- 建立依賴注入機制

### [21.4 測試系統重構](21.4-test-system-refactoring.md)
**預估時間：3.5 天**
- 移除所有 `#[serial]` 註解
- 重構所有測試使用隔離配置
- 建立測試輔助工具
- 驗證並行測試穩定性

### [21.5 命令模組和核心模組遷移](21.5-command-core-module-migration.md)
**預估時間：4.5 天**
- 重構所有命令模組接受配置服務
- 更新核心模組使用依賴注入
- 建立組件工廠模式
- 實作服務容器

### [21.6 系統清理和部署準備](21.6-system-cleanup-deployment-preparation.md)
**預估時間：3 天**
- 移除舊的配置管理程式碼
- 清理依賴和最佳化效能
- 全面測試驗證
- 更新文件和部署準備

## 總體時程規劃

| 階段 | 子任務 | 預估時間 | 累計時間 |
|------|-------|----------|----------|
| 分析設計 | 21.1 問題分析與方案設計 | 1 天 | 1 天 |
| 基礎建設 | 21.2 config crate 整合 | 2.5 天 | 3.5 天 |
| 核心實作 | 21.3 配置服務系統 | 3.5 天 | 7 天 |
| 測試重構 | 21.4 測試系統重構 | 3.5 天 | 10.5 天 |
| 模組遷移 | 21.5 命令和核心模組 | 4.5 天 | 15 天 |
| 完成部署 | 21.6 清理和部署準備 | 3 天 | **18 天** |

## 主要效益

### 立即效益
- **消除記憶體安全風險**：完全移除 `unsafe` 程式碼
- **解決測試競態條件**：實現真正的測試隔離
- **提升測試執行速度**：並行測試執行，速度提升 3-5 倍
- **簡化測試撰寫**：無需 `#[serial]` 註解和狀態重設

### 長期效益  
- **降低維護成本**：使用社區標準解決方案
- **提升開發體驗**：新開發人員更容易上手
- **增強系統穩定性**：消除隱藏的狀態共享問題
- **支援複雜配置**：為未來擴展奠定基礎

## 風險評估與緩解

### 主要風險
- **大規模重構風險**：影響整個配置系統
- **依賴變更風險**：引入新的外部依賴
- **學習曲線風險**：團隊需要適應新模式

### 緩解策略
- **分階段實作**：逐步遷移，降低風險
- **保持相容性**：提供過渡期相容性 API
- **完整測試**：建立綜合測試套件驗證功能
- **詳細文件**：提供完整的遷移指南

## 驗證標準

### 功能驗證
- [ ] 完全消除 `unsafe` 程式碼
- [ ] 所有現有功能保持正常
- [ ] 配置來源和優先級保持一致
- [ ] 環境變數和 CLI 參數正常工作

### 效能驗證
- [ ] 配置載入效能不劣於原實作
- [ ] 測試執行時間顯著改善
- [ ] 記憶體使用合理
- [ ] 並行測試穩定執行

### 安全性驗證
- [ ] 通過 `cargo clippy -- -D warnings` 檢查
- [ ] 測試並行執行 100 次無失敗
- [ ] 無全域狀態競態條件
- [ ] 完全的測試隔離

## 後續規劃

### 短期目標（完成後 1 個月）
- 監控系統穩定性
- 收集開發人員反饋
- 最佳化配置載入效能
- 完善文件和範例

### 中期目標（3 個月）
- 支援配置檔案熱重載
- 實作配置變更監控
- 支援更多配置格式
- 建立配置管理最佳實踐

### 長期目標（6 個月）
- 實作配置版本管理
- 支援分散式配置
- 建立配置管理 Web UI
- 整合配置分析工具

---

**開始執行：** 請從 [21.1 配置管理器問題分析與方案設計](21.1-config-manager-problem-analysis-design.md) 開始實作。
